// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ===================================
// 模板表 - 系统预设的模板
// ===================================
model Template {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  category    String
  framework   String
  language    String
  tags        String[]
  thumbnailUrl String? @map("thumbnail_url")
  isPublic    Boolean  @default(true) @map("is_public")
  isFeatured  Boolean  @default(false) @map("is_featured")
  usageCount  Int      @default(0) @map("usage_count")
  config      Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isActive    Boolean  @default(true) // 是否启用
  sortOrder   Int      @default(0) // 排序

  // 关联关系
  files       TemplateFile[]

  @@index([category])
  @@index([framework])
  @@index([isPublic])
  @@index([isFeatured])
  @@map("templates")
}

// ===================================
// 模板文件表
// ===================================
model TemplateFile {
  id           String   @id @default(cuid())
  templateId   String   @map("template_id")
  filePath     String   @map("file_path")
  content      String
  fileType     String   @map("file_type")
  isEntryPoint Boolean  @default(false) @map("is_entry_point")
  isEditable   Boolean  @default(true) @map("is_editable")
  orderIndex   Int      @default(0) @map("order_index")
  isReadonly   Boolean  @default(false) // 是否只读
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联关系
  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, filePath])
  @@index([templateId])
  @@map("template_files")
}

// ===================================
// 项目文件表 - 独立的项目文件管理，不依赖用户
// ===================================
model ProjectFile {
  id             String   @id @default(cuid())
  projectId      String   @map("project_id") // 项目ID，现在是独立的标识符
  filePath       String   @map("file_path")
  content        String
  fileType       String   @map("file_type")
  fileSizeBytes  Int      @map("file_size_bytes")
  contentHash    String   @map("content_hash")
  isBinary       Boolean  @default(false) @map("is_binary")
  encoding       String   @default("utf8")
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  language       String?  // 文件语言类型

  @@unique([projectId, filePath])
  @@index([projectId])
  @@index([contentHash])
  @@index([updatedAt])
  @@map("project_files")
}

// ===================================
// 系统配置表
// ===================================
model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([key])
  @@map("system_settings")
}

// ===================================
// 项目分享 - 简化版，不依赖用户
// ===================================
model SharedProject {
  id        String   @id @default(cuid())
  projectId String   @unique
  shareCode String   @unique // 分享码
  password  String?  // 访问密码（可选）
  expiresAt DateTime? // 过期时间（可选）
  viewCount Int      @default(0) // 查看次数
  createdAt DateTime @default(now())

  @@map("shared_projects")
  @@index([shareCode])
}