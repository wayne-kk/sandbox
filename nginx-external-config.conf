# 外部Nginx配置 - 支持Sandbox项目 (3100-3199端口范围)
upstream sandbox_backend {
    # 支持3100-3199端口范围，Nginx会自动选择可用的端口
    server 127.0.0.1:3100;
    server 127.0.0.1:3101;
    server 127.0.0.1:3102;
    server 127.0.0.1:3103;
    server 127.0.0.1:3104;
    server 127.0.0.1:3105;
    server 127.0.0.1:3106;
    server 127.0.0.1:3107;
    server 127.0.0.1:3108;
    server 127.0.0.1:3109;
    server 127.0.0.1:3110;
    server 127.0.0.1:3111;
    server 127.0.0.1:3112;
    server 127.0.0.1:3113;
    server 127.0.0.1:3114;
    server 127.0.0.1:3115;
    server 127.0.0.1:3116;
    server 127.0.0.1:3117;
    server 127.0.0.1:3118;
    server 127.0.0.1:3119;
    server 127.0.0.1:3120;
    server 127.0.0.1:3121;
    server 127.0.0.1:3122;
    server 127.0.0.1:3123;
    server 127.0.0.1:3124;
    server 127.0.0.1:3125;
    server 127.0.0.1:3126;
    server 127.0.0.1:3127;
    server 127.0.0.1:3128;
    server 127.0.0.1:3129;
    server 127.0.0.1:3130;
    server 127.0.0.1:3131;
    server 127.0.0.1:3132;
    server 127.0.0.1:3133;
    server 127.0.0.1:3134;
    server 127.0.0.1:3135;
    server 127.0.0.1:3136;
    server 127.0.0.1:3137;
    server 127.0.0.1:3138;
    server 127.0.0.1:3139;
    server 127.0.0.1:3140;
    server 127.0.0.1:3141;
    server 127.0.0.1:3142;
    server 127.0.0.1:3143;
    server 127.0.0.1:3144;
    server 127.0.0.1:3145;
    server 127.0.0.1:3146;
    server 127.0.0.1:3147;
    server 127.0.0.1:3148;
    server 127.0.0.1:3149;
    server 127.0.0.1:3150;
    server 127.0.0.1:3151;
    server 127.0.0.1:3152;
    server 127.0.0.1:3153;
    server 127.0.0.1:3154;
    server 127.0.0.1:3155;
    server 127.0.0.1:3156;
    server 127.0.0.1:3157;
    server 127.0.0.1:3158;
    server 127.0.0.1:3159;
    server 127.0.0.1:3160;
    server 127.0.0.1:3161;
    server 127.0.0.1:3162;
    server 127.0.0.1:3163;
    server 127.0.0.1:3164;
    server 127.0.0.1:3165;
    server 127.0.0.1:3166;
    server 127.0.0.1:3167;
    server 127.0.0.1:3168;
    server 127.0.0.1:3169;
    server 127.0.0.1:3170;
    server 127.0.0.1:3171;
    server 127.0.0.1:3172;
    server 127.0.0.1:3173;
    server 127.0.0.1:3174;
    server 127.0.0.1:3175;
    server 127.0.0.1:3176;
    server 127.0.0.1:3177;
    server 127.0.0.1:3178;
    server 127.0.0.1:3179;
    server 127.0.0.1:3180;
    server 127.0.0.1:3181;
    server 127.0.0.1:3182;
    server 127.0.0.1:3183;
    server 127.0.0.1:3184;
    server 127.0.0.1:3185;
    server 127.0.0.1:3186;
    server 127.0.0.1:3187;
    server 127.0.0.1:3188;
    server 127.0.0.1:3189;
    server 127.0.0.1:3190;
    server 127.0.0.1:3191;
    server 127.0.0.1:3192;
    server 127.0.0.1:3193;
    server 127.0.0.1:3194;
    server 127.0.0.1:3195;
    server 127.0.0.1:3196;
    server 127.0.0.1:3197;
    server 127.0.0.1:3198;
    server 127.0.0.1:3199;
}

server {
    listen 80;
    server_name 115.190.100.24;  # 或者填写您的域名
    
    # 主应用路由
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Sandbox项目静态资源路由
    location /sandbox/_next/ {
        # 使用upstream负载均衡，自动选择可用的端口
        # 移除 /sandbox 前缀，直接代理到 _next 路径
        rewrite ^/sandbox/_next/(.*)$ /_next/$1 break;
        proxy_pass http://sandbox_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
        
        # 重要：iframe相关配置
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        add_header X-Frame-Options SAMEORIGIN always;
        
        # 添加缓存头
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Sandbox项目路由 - 支持3100-3199端口范围
    location /sandbox/ {
        # 使用upstream负载均衡，自动选择可用的端口
        proxy_pass http://sandbox_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
        
        # 重要：iframe相关配置
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        add_header X-Frame-Options SAMEORIGIN always;
        
        # 添加缓存头
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # 移除路径前缀
        rewrite ^/sandbox/(.*)$ /$1 break;
    }
}

server {
    listen 443 ssl;
    server_name wayne.beer;

    ssl_certificate /etc/letsencrypt/live/wayne.beer/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wayne.beer/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 主应用路由
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Sandbox项目静态资源路由
    location /sandbox/_next/ {
        # 使用upstream负载均衡，自动选择可用的端口
        # 移除 /sandbox 前缀，直接代理到 _next 路径
        rewrite ^/sandbox/_next/(.*)$ /_next/$1 break;
        proxy_pass http://sandbox_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
        
        # 重要：iframe相关配置
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        add_header X-Frame-Options SAMEORIGIN always;
        
        # 添加缓存头
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Sandbox项目路由 - 支持3100-3199端口范围
    location /sandbox/ {
        # 使用upstream负载均衡，自动选择可用的端口
        proxy_pass http://sandbox_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
        
        # 重要：iframe相关配置
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        add_header X-Frame-Options SAMEORIGIN always;
        
        # 添加缓存头
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # 移除路径前缀
        rewrite ^/sandbox/(.*)$ /$1 break;
    }
}