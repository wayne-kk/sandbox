# V0-Sandbox 项目详细说明文档

## 📋 项目概述

V0-Sandbox 是一个功能强大的在线代码编辑器和开发环境，专注于 React/Next.js 项目的快速原型开发和 AI 辅助代码生成。它提供了完整的 IDE 体验，包括代码编辑、实时预览、Docker 容器化运行环境，以及基于 Dify 的 AI 代码生成功能。

### 核心特性

- 🎨 **Monaco 编辑器**：基于 VS Code 的强大代码编辑体验
- 📁 **文件管理**：支持多文件编辑和项目结构管理
- 🐳 **Docker 沙箱**：安全隔离的项目运行环境
- ⚡ **实时预览**：即时查看项目运行结果
- 💾 **自动保存**：编辑时自动保存文件
- 🤖 **AI 代码生成**：集成 Dify AI 进行智能代码生成
- 🔄 **热重载**：文件修改后自动重新加载
- 📥 **GitHub 导入**：支持从 GitHub 仓库直接导入项目
- 🖥️ **增强终端**：支持命令执行和进程管理

## 🏗️ 技术架构

### 前端技术栈

- **Next.js 15.3.3**：React 全栈框架
- **React 18**：用户界面库
- **TypeScript**：类型安全的 JavaScript
- **Tailwind CSS**：样式框架
- **Monaco Editor**：代码编辑器
- **Lucide React**：图标库
- **Radix UI**：无障碍 UI 组件

### 后端技术栈

- **Node.js 18**：服务器运行时
- **Docker**：容器化运行环境
- **Prisma**：数据库 ORM
- **SQLite**：数据库
- **WebSocket**：实时通信

### AI 集成

- **Dify 平台**：AI 工作流管理
- **组件分析器**：自动分析项目组件库
- **智能上下文构建**：为 AI 提供项目上下文

## 🎯 核心功能模块

### 1. 集成开发环境 (IDE)

#### 文件管理器

- **路径**: `src/components/IDE/IntegratedIDE.tsx`
- **功能**:
  - 树状文件浏览器
  - 多标签文件编辑
  - 文件新建/删除/重命名
  - 项目文件自动加载

#### 代码编辑器

- **基于**: Monaco Editor
- **特性**:
  - 语法高亮
  - 智能提示
  - 错误检测
  - 代码格式化
  - 多语言支持 (TypeScript, JavaScript, CSS, JSON, Markdown)

#### 实时预览

- **机制**: iframe 嵌入
- **功能**:
  - 实时热重载
  - 多端口自动分配
  - 错误状态显示
  - 预览链接生成

### 2. 容器化运行环境

#### Docker 管理器

- **路径**: `src/lib/docker.ts`
- **功能**:
  - 容器创建和管理
  - 镜像构建和拉取
  - 进程监控和控制
  - 资源清理

#### 项目管理器

- **路径**: `src/lib/project-manager.ts`
- **功能**:
  - 项目生命周期管理
  - 端口自动分配 (3100-3199)
  - 依赖安装
  - 构建日志管理
  - WebSocket 状态同步

### 3. AI 代码生成系统

#### Dify 客户端

- **路径**: `src/lib/ai/dify-client.ts`
- **功能**:
  - 与 Dify API 通信
  - 组件上下文分析
  - 代码生成和解析
  - 会话管理

#### 组件分析器

- **路径**: `src/lib/ai/component-analyzer.ts`
- **功能**:
  - 自动分析 shadcn/ui 组件
  - 生成组件文档
  - 提取 Props 和变体信息
  - 为 AI 提供组件上下文

#### 智能上下文构建器

- **路径**: `src/lib/ai/smart-context-builder.ts`
- **功能**:
  - 项目结构分析
  - 依赖关系映射
  - 设计系统文档生成
  - 开发约定提取

### 4. 增强终端

#### 终端组件

- **路径**: `src/components/Terminal/EnhancedTerminal.tsx`
- **功能**:
  - 实时命令执行
  - 命令历史和自动补全
  - 进程管理
  - SSE 流式输出
  - 快捷键支持

#### API 路由

- **路径**: `src/app/api/terminal/route.ts`
- **功能**:
  - 命令执行
  - 进程监控
  - 容器管理
  - 状态检查

## 🔌 API 接口设计

### 1. 项目管理 API

#### 启动项目

```http
POST /api/project
{
  "action": "start",
  "projectId": "sandbox-project",
  "framework": "nextjs"
}
```

#### 停止项目

```http
POST /api/project
{
  "action": "stop",
  "projectId": "sandbox-project"
}
```

#### 更新文件

```http
POST /api/project
{
  "action": "update",
  "projectId": "sandbox-project",
  "files": {
    "src/App.tsx": "文件内容..."
  }
}
```

### 2. AI 生成 API

#### 生成 UI 组件

```http
POST /api/ai/generate
{
  "prompt": "创建一个登录页面",
  "projectType": "nextjs",
  "projectId": "sandbox-project"
}
```

#### 配置检查

```http
GET /api/ai/config-check
```

### 3. 沙箱管理 API

#### 运行项目

```http
POST /api/sandbox/run
{
  "type": "nextjs"
}
```

#### 保存文件

```http
POST /api/sandbox/files
{
  "files": {
    "src/App.tsx": "文件内容..."
  }
}
```

#### 重置沙箱

```http
POST /api/sandbox/reset
{
  "confirmReset": true
}
```

### 4. GitHub 集成 API

#### 下载项目

```http
POST /api/github/download
{
  "url": "https://github.com/user/repo",
  "branch": "main"
}
```

## 🎨 用户界面设计

### 1. 主界面布局

```
┌─────────────────────────────────────────────────────────┐
│ 🚀 V0 Sandbox - 顶部导航栏                                │
├─────────────────────────────────────────────────────────┤
│ [代码编辑器] [实时预览] [终端] - 标签页                      │
├──────────────┬──────────────────────────────────────────┤
│ 文件浏览器    │ 主编辑区域                                  │
│ 📁 src/      │ Monaco 编辑器 / 预览 iframe / 终端         │
│ 📄 App.tsx   │                                          │
│ 📄 index.css │                                          │
├──────────────┴──────────────────────────────────────────┤
│ 状态栏 - 项目状态、文件信息、快捷键提示                      │
└─────────────────────────────────────────────────────────┘
```

### 2. AI 生成器界面

```
┌─────────────────────────────────────────────────────────┐
│ 🤖 AI 组件生成器                                          │
├─────────────────────────────────────────────────────────┤
│ 描述输入框: "创建一个用户登录页面..."                        │
├─────────────────────────────────────────────────────────┤
│ [快速示例] 登录页面 | 数据仪表板 | 博客卡片                  │
├─────────────────────────────────────────────────────────┤
│ 进度条: ████████░░ 80% 正在生成代码...                      │
├─────────────────────────────────────────────────────────┤
│ 生成日志:                                                 │
│ [时间] 🤖 开始 AI 代码生成...                              │
│ [时间] 📚 正在分析组件库...                                │
│ [时间] ✅ 生成完成！共生成 3 个文件                          │
├─────────────────────────────────────────────────────────┤
│ 结果摘要: 3 个文件 | 8 个功能 | 2 个依赖                     │
└─────────────────────────────────────────────────────────┘
```

## 📊 数据库设计

### 项目文件表 (ProjectFile)

```sql
CREATE TABLE project_files (
  id TEXT PRIMARY KEY,
  projectId TEXT NOT NULL,
  filePath TEXT NOT NULL,
  content TEXT NOT NULL,
  size INTEGER DEFAULT 0,
  language TEXT,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(projectId, filePath)
);
```

### 模板表 (Template)

```sql
CREATE TABLE templates (
  id TEXT PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  displayName TEXT NOT NULL,
  description TEXT,
  framework TEXT NOT NULL,
  isActive BOOLEAN DEFAULT TRUE,
  sortOrder INTEGER DEFAULT 0,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 模板文件表 (TemplateFile)

```sql
CREATE TABLE template_files (
  id TEXT PRIMARY KEY,
  templateId TEXT NOT NULL,
  filePath TEXT NOT NULL,
  content TEXT NOT NULL,
  isReadonly BOOLEAN DEFAULT FALSE,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (templateId) REFERENCES templates(id) ON DELETE CASCADE,
  UNIQUE(templateId, filePath)
);
```

## ⚙️ 配置文件说明

### 环境变量配置

```bash
# AI 集成配置
DIFY_API_ENDPOINT=your_dify_api_endpoint
COMPONENT_DIFY_API_KEY=your_component_api_key
REQUIREMENT_DIFY_API_KEY=your_requirement_api_key

# 应用配置
NEXT_PUBLIC_BASE_URL=http://localhost:3000

# 数据库配置 (Prisma)
DATABASE_URL="file:./dev.db"
```

### Next.js 配置

```javascript
// next.config.ts
const nextConfig = {
  experimental: {
    serverComponentsExternalPackages: ["prisma"],
  },
};
```

### Tailwind 配置

```javascript
// tailwind.config.js
module.exports = {
  content: [
    "./src/**/*.{js,ts,jsx,tsx,mdx}",
    "./sandbox/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
```

## 🔄 工作流程

### 1. 项目启动流程

```mermaid
graph TD
    A[用户访问首页] --> B[加载 IntegratedIDE 组件]
    B --> C[初始化文件系统]
    C --> D[建立 WebSocket 连接]
    D --> E[加载 sandbox 文件]
    E --> F[Monaco 编辑器就绪]
    F --> G[用户可以开始编辑]

    G --> H[用户点击运行项目]
    H --> I[ProjectManager.startProject]
    I --> J[查找可用端口]
    J --> K[更新 package.json 端口]
    K --> L[启动 npm run dev]
    L --> M[监听进程输出]
    M --> N[检测服务器启动]
    N --> O[更新项目状态为 running]
    O --> P[推送 WebSocket 状态更新]
    P --> Q[前端显示预览 URL]
```

### 2. AI 代码生成流程

```mermaid
graph TD
    A[用户输入提示词] --> B[DifyUIGenerator 组件]
    B --> C[调用 /api/ai/generate]
    C --> D[ComponentAnalyzer 分析组件库]
    D --> E[SmartContextBuilder 构建上下文]
    E --> F[DifyClient 调用 AI API]
    F --> G[解析 AI 响应]
    G --> H[验证生成的文件]
    H --> I[ProjectManager.saveProjectFiles]
    I --> J[写入 sandbox 目录]
    J --> K[触发热重载]
    K --> L[前端显示生成结果]
```

### 3. 文件保存和同步流程

```mermaid
graph TD
    A[用户编辑文件] --> B[Monaco onChange 事件]
    B --> C[updateFileContent 更新状态]
    C --> D[标记文件为 dirty]
    D --> E[自动保存定时器触发]
    E --> F[调用 /api/project update]
    F --> G[ProjectManager.saveProjectFiles]
    G --> H[写入文件系统]
    H --> I[项目热重载]
    I --> J[WebSocket 推送更新]
    J --> K[前端同步状态]
```

## 🛠️ 开发指南

### 1. 本地开发环境搭建

```bash
# 克隆项目
git clone <repository-url>
cd v0-sandbox

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env.local
# 编辑 .env.local 填入 Dify API 配置

# 初始化数据库
npx prisma generate
npx prisma db push

# 启动开发服务器
npm run dev
```

### 2. Docker 开发环境

```bash
# 使用 Docker Compose
docker-compose up

# 或单独构建
docker build -t v0-sandbox .
docker run -p 3000:3000 v0-sandbox
```

### 3. 新增 AI 功能

```typescript
// 1. 创建新的 AI 客户端
class CustomAIClient {
  async generateCode(prompt: string): Promise<GenerateResult> {
    // 实现代码生成逻辑
  }
}

// 2. 在 AI 路由中集成
// src/app/api/ai/custom/route.ts
export async function POST(request: Request) {
  const client = new CustomAIClient();
  const result = await client.generateCode(prompt);
  return NextResponse.json(result);
}

// 3. 前端组件调用
const handleGenerate = async () => {
  const response = await fetch("/api/ai/custom", {
    method: "POST",
    body: JSON.stringify({ prompt }),
  });
};
```

### 4. 扩展文件类型支持

```typescript
// 在 Monaco 配置中添加新语言
// src/lib/monaco-config.ts
export class MonacoConfig {
  static configureLanguage(monaco: Monaco, language: string) {
    switch (language) {
      case "vue":
        monaco.languages.register({ id: "vue" });
        // 配置 Vue 语法高亮
        break;
      case "svelte":
        monaco.languages.register({ id: "svelte" });
        // 配置 Svelte 语法高亮
        break;
    }
  }
}
```

## 🔧 部署指南

### 1. 生产环境部署

```bash
# 构建项目
npm run build

# 启动生产服务器
npm start

# 或使用 PM2
pm2 start npm --name "v0-sandbox" -- start
```

### 2. Docker 部署

```dockerfile
# 生产 Dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
```

### 3. 环境变量配置

```bash
# 生产环境变量
NODE_ENV=production
NEXT_PUBLIC_BASE_URL=https://your-domain.com
DIFY_API_ENDPOINT=https://your-dify-api.com
DATABASE_URL=postgresql://user:pass@host:5432/db
```

## 📈 性能优化

### 1. 前端优化

- **代码分割**: 使用 Next.js 动态导入
- **图片优化**: Next.js Image 组件
- **缓存策略**: SWR 数据获取
- **Bundle 分析**: webpack-bundle-analyzer

### 2. 后端优化

- **数据库索引**: Prisma 查询优化
- **API 缓存**: Redis 缓存层
- **文件系统**: 内存文件系统选项
- **WebSocket**: 连接池管理

### 3. Docker 优化

- **多阶段构建**: 减小镜像大小
- **资源限制**: CPU 和内存约束
- **健康检查**: 容器状态监控
- **日志管理**: 结构化日志输出

## 🔒 安全考虑

### 1. 代码执行安全

- **沙箱隔离**: Docker 容器隔离
- **资源限制**: CPU、内存、网络限制
- **文件系统**: 只读根文件系统
- **用户权限**: 非 root 用户运行

### 2. API 安全

- **输入验证**: 严格的参数校验
- **Rate Limiting**: API 调用频率限制
- **CORS 配置**: 跨域请求控制
- **认证授权**: JWT 或 Session 管理

### 3. 数据安全

- **SQL 注入**: Prisma ORM 防护
- **XSS 防护**: 输入输出转义
- **CSRF 保护**: Token 验证
- **敏感信息**: 环境变量管理

## 🐛 故障排除

### 1. 常见问题

#### Docker 相关

```bash
# Docker 服务未启动
sudo systemctl start docker

# 权限问题
sudo usermod -aG docker $USER

# 容器端口冲突
docker ps -a
docker stop <container-id>
```

#### AI 生成失败

```bash
# 检查 Dify API 配置
curl -X POST $DIFY_API_ENDPOINT \
  -H "Authorization: Bearer $DIFY_API_KEY" \
  -d '{"inputs": {"query": "test"}}'

# 查看详细错误日志
tail -f /var/log/v0-sandbox.log
```

#### 项目启动失败

```bash
# 检查端口占用
netstat -tulpn | grep :3000

# 清理 node_modules
rm -rf sandbox/node_modules
cd sandbox && npm install

# 重置 sandbox
curl -X POST localhost:3000/api/sandbox/reset \
  -H "Content-Type: application/json" \
  -d '{"confirmReset": true}'
```

### 2. 日志分析

```bash
# 应用日志
docker logs v0-sandbox

# 系统资源
docker stats

# 磁盘使用
df -h
du -sh sandbox/
```

## 📚 扩展资源

### 1. 相关文档

- [Next.js 官方文档](https://nextjs.org/docs)
- [Monaco Editor API](https://microsoft.github.io/monaco-editor/api/)
- [Docker 官方文档](https://docs.docker.com/)
- [Prisma 文档](https://www.prisma.io/docs)

### 2. 社区资源

- [Dify 社区](https://github.com/langgenius/dify)
- [shadcn/ui 组件库](https://ui.shadcn.com/)
- [Tailwind CSS](https://tailwindcss.com/docs)

### 3. 开发工具

- [VS Code Prisma 扩展](https://marketplace.visualstudio.com/items?itemName=Prisma.prisma)
- [Docker Desktop](https://www.docker.com/products/docker-desktop)
- [Postman API 测试](https://www.postman.com/)

## 🎯 未来规划

### 1. 功能扩展

- [ ] 支持更多前端框架 (Vue.js, Svelte)
- [ ] 集成更多 AI 模型 (OpenAI, Claude)
- [ ] 多用户协作编辑
- [ ] 版本控制集成 (Git)
- [ ] 项目模板市场

### 2. 性能提升

- [ ] 服务端渲染优化
- [ ] 边缘计算部署
- [ ] 智能缓存策略
- [ ] 增量构建支持

### 3. 开发体验

- [ ] 可视化项目配置
- [ ] 智能错误诊断
- [ ] 性能监控仪表板
- [ ] 插件系统架构

---

## 📞 联系方式

如有问题或建议，请通过以下方式联系：

- 项目仓库: [GitHub Issues](https://github.com/your-repo/v0-sandbox/issues)
- 文档更新: 2024 年 12 月
- 版本: v1.0.0

**感谢使用 V0-Sandbox！** 🚀
